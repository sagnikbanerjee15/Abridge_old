samtools
fclqc

cd /Users/baners23/work/ABRIDGE/Abridge
git add .; git commit -m "push"; git push; cd ../../dockerized_tools_and_pipelines; git add .; git commit -m "push"; git push; cd -;
docker rmi ghcr.io/sagnikbanerjee15/dockerized_tools_and_pipelines/abridge:1.1.0; git pull; docker build -t ghcr.io/sagnikbanerjee15/dockerized_tools_and_pipelines/abridge:1.1.0 .; docker push ghcr.io/sagnikbanerjee15/dockerized_tools_and_pipelines/abridge:1.1.0
# Small sample 
cd ../Abridge && git pull && cd - && rm -rf SRR13711353_SE_compress_test && nohup /work/ABRIDGE/Abridge/abridge -ialigned /work/ABRIDGE/testing/SRR13711353_SE_small.sam --compress -o /work/ABRIDGE/testing/SRR13711353_SE_compress_test --genome /work/ABRIDGE/testing/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa --preserve_all_intermediate_files --keep_intermediate_error_files > /work/ABRIDGE/testing/SRR13711353_SE_compress_test.output 2> /work/ABRIDGE/testing/SRR13711353_SE_compress_test.error &

# singularity pulls
rm -rf ~/.singularity
rm /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test/singularity_images/abridge:1.1.0 ; singularity pull --disable-cache /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test/singularity_images/abridge:1.1.0 docker://ghcr.io/sagnikbanerjee15/dockerized_tools_and_pipelines/abridge:1.1.0
singularity pull --disable-cache /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test/singularity_images/samtools:1.14 docker://ghcr.io/sagnikbanerjee15/dockerized_tools_and_pipelines/samtools:1.14
singularity pull --disable-cache /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test/singularity_images/zpaq:715 docker://ghcr.io/sagnikbanerjee15/dockerized_tools_and_pipelines/zpaq:715
singularity pull --disable-cache /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test/singularity_images/fclqc:latest docker://ghcr.io/sagnikbanerjee15/dockerized_tools_and_pipelines/fclqc:latest

rm -rf ~/.singularity
rm /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_compress_test/singularity_images/abridge:1.1.0 
cp /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test/singularity_images/* /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_compress_test/singularity_images/

mkdir -p /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_decompress_test/singularity_images
cp /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test/singularity_images/* /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_decompress_test/singularity_images/

mkdir -p /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_decompress_test/singularity_images
cp /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test/singularity_images/* /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_decompress_test/singularity_images/

mkdir -p /project/maizegdb/sagnik/ABRIDGE/testing/reference/star_index
STAR \
--runMode genomeGenerate \
--runThreadN 45 \
--genomeDir /project/maizegdb/sagnik/ABRIDGE/testing/reference/star_index \
--genomeFastaFiles /project/maizegdb/sagnik/ABRIDGE/testing/reference/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \
--genomeSAindexNbases 12

# Single ended

STAR \
--runThreadN 45 \
--genomeDir /project/maizegdb/sagnik/ABRIDGE/testing/reference/star_index \
--readFilesIn /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_0.fastq \
--outFilterMultimapNmax 10000 \
--outFilterMismatchNmax 10 \
--limitBAMsortRAM 107374182400 \
--outFilterScoreMinOverLread 0.60 \
--outFilterMatchNminOverLread 0.60 \
--outSAMattributes NH HI AS nM NM MD jM jI XS \
--outFileNamePrefix /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_ \
--outSAMtype BAM SortedByCoordinate \
--alignIntronMin 20 \
--alignIntronMax 10000 \
--outReadsUnmapped  Within

# Paired ended

STAR \
--runThreadN 45 \
--genomeDir /project/maizegdb/sagnik/ABRIDGE/testing/reference/star_index \
--readFilesIn /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_1.fastq /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_2.fastq \
--outFilterMultimapNmax 10000 \
--outFilterMismatchNmax 10 \
--limitBAMsortRAM 107374182400 \
--outFilterScoreMinOverLread 0.60 \
--outFilterMatchNminOverLread 0.60 \
--outSAMattributes NH HI AS nM NM MD jM jI XS \
--outFileNamePrefix /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_ \
--outSAMtype BAM SortedByCoordinate \
--alignIntronMin 20 \
--alignIntronMax 10000 \
--outReadsUnmapped  Within


#####################################################################################################################################################
# Compress
#####################################################################################################################################################
# Whole sample

nohup /project/maizegdb/sagnik/ABRIDGE/Abridge/abridge \
-ialigned /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE.sam \
--compress -o /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test \
--genome /project/maizegdb/sagnik/ABRIDGE/testing/reference/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \
--preserve_all_intermediate_files --keep_intermediate_error_files \
1> /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test.output \
2> /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test.error &

 
nohup /project/maizegdb/sagnik/ABRIDGE/Abridge/abridge \
-ialigned /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE.sam \
--compress -o /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_compress_test \
--genome /project/maizegdb/sagnik/ABRIDGE/testing/reference/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \
--preserve_all_intermediate_files \
--keep_intermediate_error_files \
> /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_compress_test.output \
2> /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_compress_test.error &

valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes --verbose

#####################################################################################################################################################
# Decompress
#####################################################################################################################################################

nohup /project/maizegdb/sagnik/ABRIDGE/Abridge/abridge \
--inputabrfilename /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_compress_test/SRR13711353_SE.abridge \
--decompress -o /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_decompress_test \
--genome /project/maizegdb/sagnik/ABRIDGE/testing/reference/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \
--preserve_all_intermediate_files \
--keep_intermediate_error_files \
> /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_decompress_test.output \
2> /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_SE_decompress_test.error &


nohup /project/maizegdb/sagnik/ABRIDGE/Abridge/abridge \
--inputabrfilename /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_compress_test/SRR13711353_PE.abridge \
--decompress -o /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_decompress_test \
--genome /project/maizegdb/sagnik/ABRIDGE/testing/reference/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa \
--preserve_all_intermediate_files \
--keep_intermediate_error_files \
> /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_decompress_test.output \
2> /project/maizegdb/sagnik/ABRIDGE/testing/SRR13711353_PE_decompress_test.error &

###################################################################
# Commands for creating smaller sam file for testing purpose
###################################################################

# Extract headers
cat SRR13711353_SE.sam | grep ^@ > SRR13711353_SE_headers.sam

# Extract non-spliced alignments that are a perfect match to the reference
cat <(cat SRR13711353_SE_headers.sam| grep ^@ ) <(cat SRR13711353_SE.sam | awk '$6 !~ /N/' | grep MD:Z:151 | shuf -n 10000) > SRR13711353_SE_non_spliced_perfect.sam

# Extract spliced alignments that are a perfect match to the reference
cat <(cat SRR13711353_SE_headers.sam| grep ^@ ) <(cat SRR13711353_SE.sam | awk '$6 ~ /N/' | grep MD:Z:151 | shuf -n 10000) > SRR13711353_SE_spliced_perfect.sam

# Extract non-spliced alignments that contain mismatches
cat <(cat SRR13711353_SE_headers.sam| grep ^@ ) <(cat SRR13711353_SE.sam | awk '$6 !~ /N/' | grep -E "MD:Z:[0-9]*[ATGC]*[0-9]*" | shuf -n 10000) > SRR13711353_SE_non_spliced_perfect.sam